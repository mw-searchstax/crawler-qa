<script>
const config = {
  searchURL: 'https://searchcloud-1-us-east-1.searchstax.com/29847/tutorialqacrawlerapi-5641/emselect',
  suggestURL: 'https://searchcloud-1-us-east-1.searchstax.com/29847/tutorialqacrawlerapi-5641_suggester/emsuggest',
  authHeader: '9a6f1b606dc700b4af156713a8b6f13a425558b0' // use the SAME value for both calls
};

// Search
document.getElementById('go').addEventListener('click', async () => {
  const q = document.getElementById('q').value.trim();
  if (!q) return;
  const url = new URL(config.searchURL);
  url.searchParams.set('q', q);

  const resp = await fetch(url.toString(), {
    headers: { Authorization: config.authHeader, Accept: 'application/json' }
  });
  const data = await resp.json();

  const docs = data.response?.docs || [];
  const list = document.getElementById('results');
  list.innerHTML = '';
  docs.forEach(doc => {
    const li = document.createElement('li');
    const title = Array.isArray(doc.title) ? doc.title[0] : doc.title;
    li.textContent = title || doc.name || doc.url || '(untitled)';
    list.appendChild(li);
  });
});

// Auto-suggest
const input = document.getElementById('q');
const box = document.createElement('ul');
box.id = 'suggestions';
input.after(box);

let timer;
input.addEventListener('input', () => {
  clearTimeout(timer);
  const term = input.value.trim();
  if (!term) { box.innerHTML = ''; return; }

  timer = setTimeout(async () => {
    try {
      const u = new URL(config.suggestURL);
      u.searchParams.set('q', term);                // keep 'q' for emsuggest
      // u.searchParams.set('suggest.q', term);     // if your handler expects Solr-style, swap to this

      const r = await fetch(u.toString(), {
        headers: { Authorization: config.authHeader, Accept: 'application/json' }
      });
      if (!r.ok) throw new Error(`Suggest HTTP ${r.status}`);
      const s = await r.json();

      // Robust parsing: s.suggest[<dict>][<term>].suggestions[] OR a flat array
      const dictObj = s.suggest || {};
      const firstDictVal = Object.values(dictObj)[0] || {};
      const firstEntryVal = Object.values(firstDictVal)[0] || { suggestions: [] };
      const rawItems = Array.isArray(s.suggestions) ? s.suggestions : firstEntryVal.suggestions || [];

      const items = rawItems.map(x => (typeof x === 'string' ? x : x.term || x.payload || '')).filter(Boolean);

      box.innerHTML = '';
      items.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        li.onclick = () => { input.value = text; input.dispatchEvent(new Event('input')); };
        box.appendChild(li);
      });
    } catch (e) {
      box.innerHTML = ''; // fail closed
      console.error('Suggest error', e);
    }
  }, 120);
});
</script>